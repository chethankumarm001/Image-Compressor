<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart PCA Image Compressor</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #ddd6fe 50%, #fae8ff 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #111827;
        }

        .header p {
            font-size: 1.25rem;
            color: #4b5563;
            max-width: 48rem;
            margin: 0 auto;
        }

        /* Feature Cards */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(219, 234, 254, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            border-color: #3b82f6;
        }

        .feature-card::after {
            content: 'Click for details';
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            font-size: 0.75rem;
            color: #3b82f6;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .feature-card:hover::after {
            opacity: 1;
        }

        .feature-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .feature-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0;
            color: #111827;
        }

        .feature-card p {
            display: none;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 1rem;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .modal-icon {
            width: 4rem;
            height: 4rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
        }

        .modal-description {
            color: #4b5563;
            line-height: 1.7;
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #f3f4f6;
            border: none;
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: #6b7280;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #e5e7eb;
            color: #111827;
        }

        /* Upload Box */
        .upload-container {
            max-width: 42rem;
            margin: 0 auto;
        }

        /* Upload Box ‚Äî FIXED */
.upload-box {
    position: relative;
    border: 2px dashed #6b7280;   /* darker & visible border */
    border-radius: 0.75rem;
    padding: 3rem;
    min-height: 220px;            /* FIX: ensures borders are not clipped */
    text-align: center;

    background: rgba(255, 255, 255, 0.88); /* FIX: visible on gradient bg */
    backdrop-filter: blur(6px);            /* keep your glass effect */

    display: flex;                 /* FIX: centers icon + text perfectly */
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 1rem;

    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-box:hover,
.upload-box.drag-active {
    border-color: #2563eb;
    background: rgba(219, 234, 254, 0.55);  /* cleaner hover */
    transform: scale(1.015);
}

        .upload-icon {
            width: 4rem;
            height: 4rem;
            background: #dbeafe;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
        }

        .upload-box h3 {
            font-size: 1.125rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .upload-box p {
            font-size: 0.875rem;
            color: #6b7280;
        }

        #imageInput {
            display: none;
        }

        /* Controls */
        .controls-box {
            max-width: 42rem;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .controls-header {
            margin-bottom: 1.5rem;
        }

        .controls-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .controls-header p {
            color: #6b7280;
        }

        .slider-container {
            margin-bottom: 2rem;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .slider-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .slider-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3b82f6;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 0.5rem;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #6b7280;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-outline {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-outline:hover {
            background: #f9fafb;
        }

        /* Results */
        .results-container {
            margin-top: 2rem;
        }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-header h2 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .results-header p {
            color: #6b7280;
        }

        .comparison-box {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .image-box {
            position: relative;
        }

        .image-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .image-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .size-badge {
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
        }

        .badge-gray {
            background: #f3f4f6;
            color: #6b7280;
        }

        .badge-green {
            background: #d1fae5;
            color: #065f46;
        }

        .image-box img {
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #e5e7eb;
        }

        .image-box:last-child img {
            border-color: #86efac;
        }

        /* Stats */
        .stats-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
        }

        .stats-section h3 {
            text-align: center;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #e9d5ff, #d8b4fe);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #fed7aa, #fdba74);
        }

        .stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-subtext {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            opacity: 0.8;
        }

        /* Quality Indicator */
        .quality-indicator {
            margin-top: 1.5rem;
            background: linear-gradient(90deg, #dbeafe, #e9d5ff);
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .quality-indicator p {
            font-size: 0.875rem;
            color: #374151;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            margin-top: 2rem;
        }

        @media (min-width: 640px) {
            .action-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }

        /* Info Section */
        .info-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(199, 210, 254, 0.8);
            margin-top: 3rem;
        }

        .info-section h3 {
            font-size: 2rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .info-section p {
            color: #4b5563;
            line-height: 1.7;
            text-align: center;
            max-width: 64rem;
            margin: 0 auto;
        }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .step {
            text-align: center;
        }

        .step-number {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .step h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .step p {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Smart PCA Image Compressor</h1>
            <p>Fast, efficient and intelligent image compression using Principal Component Analysis</p>
        </div>

        <!-- Feature Cards -->
        <div class="features-grid">
            <div class="feature-card" data-title="Lightning Fast" data-description="Process images instantly in your browser. No server uploads, no waiting times.">
                <div class="feature-icon" style="background: #dbeafe;">‚ö°</div>
                <h3>Lightning Fast</h3>
                <p>Process images instantly in your browser. No server uploads, no waiting times.</p>
            </div>
            <div class="feature-card" data-title="100% Private" data-description="All processing happens locally. Your images never leave your device.">
                <div class="feature-icon" style="background: #e9d5ff;">üîí</div>
                <h3>100% Private</h3>
                <p>All processing happens locally. Your images never leave your device.</p>
            </div>
            <div class="feature-card" data-title="Smart Algorithm" data-description="PCA preserves important features while dramatically reducing file size.">
                <div class="feature-icon" style="background: #c7d2fe;">üéØ</div>
                <h3>Smart Algorithm</h3>
                <p>PCA preserves important features while dramatically reducing file size.</p>
            </div>
        </div>

        <!-- Upload Section -->
        <div id="uploadSection" class="upload-container">
            <label for="imageInput" class="upload-box" id="uploadBox">
                <div class="upload-icon">üì§</div>
                <h3>Drop your image here or click to browse</h3>
                <p>PNG, JPG, or WebP (max 10MB)</p>
                <input type="file" id="imageInput" accept="image/*">
            </label>
        </div>

        <!-- Controls Section -->
        <div id="controlsSection" class="controls-box hidden">
            <div class="controls-header">
                <h2>Configure Compression</h2>
                <p id="fileName">Selected: image.jpg</p>
            </div>

            <div class="slider-container">
                <div class="slider-header">
                    <span class="slider-label">Number of Components</span>
                    <span class="slider-value" id="componentsValue">50</span>
                </div>
                <input type="range" class="slider" id="componentsSlider" min="10" max="100" step="5" value="50">
                <div class="slider-labels">
                    <span>Higher compression</span>
                    <span>Better quality</span>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="compressBtn">
                    Compress Image
                </button>
                <button class="btn btn-outline" id="cancelBtn">
                    Cancel
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-container hidden">
            <div class="results-header">
                <h2>Compression Results</h2>
                <p>Compare the original and compressed images side by side</p>
            </div>

            <div class="comparison-box">
                <div class="images-grid">
                    <!-- Original Image -->
                    <div class="image-box">
                        <div class="image-header">
                            <h3>Original</h3>
                            <span class="size-badge badge-gray" id="originalSizeBadge">0 KB</span>
                        </div>
                        <img id="originalImage" src="" alt="Original">
                    </div>

                    <!-- Compressed Image -->
                    <div class="image-box">
                        <div class="image-header">
                            <h3>Compressed</h3>
                            <span class="size-badge badge-green" id="compressedSizeBadge">0 KB</span>
                        </div>
                        <img id="compressedImage" src="" alt="Compressed">
                    </div>
                </div>

                <!-- Stats Section -->
                <div class="stats-section">
                    <h3>Quality & Size Analysis</h3>
                    
                    <div class="stats-grid">
                        <div class="stat-card blue">
                            <p class="stat-label" style="color: #1e40af;">Original Size</p>
                            <p class="stat-value" style="color: #1e3a8a;" id="statOriginalSize">0 KB</p>
                        </div>

                        <div class="stat-card green">
                            <p class="stat-label" style="color: #065f46;">Compressed Size</p>
                            <p class="stat-value" style="color: #064e3b;" id="statCompressedSize">0 KB</p>
                        </div>

                        <div class="stat-card purple">
                            <p class="stat-label" style="color: #6b21a8;">Compression Ratio</p>
                            <p class="stat-value" style="color: #581c87;" id="statRatio">0:1</p>
                            <p class="stat-subtext" style="color: #7c3aed;">Space saved</p>
                        </div>

                        <div class="stat-card orange">
                            <p class="stat-label" style="color: #c2410c;">Quality Loss (MSE)</p>
                            <p class="stat-value" style="color: #9a3412;" id="statMSE">0</p>
                            <p class="stat-subtext" style="color: #ea580c;">Lower is better</p>
                        </div>
                    </div>

                    <!-- Quality Indicator -->
                    <div class="quality-indicator">
                        <span>‚ÑπÔ∏è</span>
                        <p id="qualityText">Processing...</p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-primary" id="anotherImageBtn">
                    Compress Another Image ‚Üí
                </button>
                <button class="btn btn-outline" id="downloadBtn">
                    Download Compressed
                </button>
            </div>

            <!-- Educational Content -->
            <div class="info-section">
                <h3>How PCA Compression Works</h3>
                <p>
                    Principal Component Analysis (PCA) reduces image dimensionality by identifying and keeping 
                    the most important components that contain the majority of visual information. This technique 
                    provides high compression rates with minimal perceptual quality loss, making it perfect for 
                    applications where storage efficiency matters without sacrificing too much visual fidelity. 
                    The algorithm transforms the image data into a new coordinate system where the greatest 
                    variance lies on the first coordinates (principal components).
                </p>
            </div>
        </div>

        <!-- How it Works Section (Initial) -->
        <div id="howItWorksSection" class="info-section">
            <h3>How PCA Compression Works</h3>
            <div class="steps-grid">
                <div class="step">
                    <div class="step-number" style="background: #dbeafe; color: #1e40af;">1</div>
                    <h4>Upload Image</h4>
                    <p>Select or drag & drop your PNG or JPG image file</p>
                </div>
                <div class="step">
                    <div class="step-number" style="background: #e9d5ff; color: #6b21a8;">2</div>
                    <h4>Adjust Settings</h4>
                    <p>Choose compression level - balance between quality and file size</p>
                </div>
                <div class="step">
                    <div class="step-number" style="background: #d1fae5; color: #065f46;">3</div>
                    <h4>Download Result</h4>
                    <p>Compare quality and download your optimized image</p>
                </div>
            </div>
            <p>
                Principal Component Analysis (PCA) is a dimensionality reduction technique that transforms 
                image data into a new coordinate system. By keeping only the principal components that 
                contain the most variance (visual information), we can dramatically reduce file size while 
                preserving the essential features of your image. This makes PCA ideal for machine learning 
                pipelines, web optimization, and any scenario where efficient storage is crucial.
            </p>
        </div>
    </div>

    <script>
        // State
        let selectedFile = null;
        let components = 50;
        let compressedDataUrl = null;

        // DOM Elements
        const uploadBox = document.getElementById('uploadBox');
        const imageInput = document.getElementById('imageInput');
        const uploadSection = document.getElementById('uploadSection');
        const controlsSection = document.getElementById('controlsSection');
        const resultsSection = document.getElementById('resultsSection');
        const howItWorksSection = document.getElementById('howItWorksSection');
        const fileName = document.getElementById('fileName');
        const componentsSlider = document.getElementById('componentsSlider');
        const componentsValue = document.getElementById('componentsValue');
        const compressBtn = document.getElementById('compressBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const anotherImageBtn = document.getElementById('anotherImageBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        // Drag and Drop
        uploadBox.addEventListener('dragenter', (e) => {
            e.preventDefault();
            uploadBox.classList.add('drag-active');
        });

        uploadBox.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('drag-active');
        });

        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('drag-active');
            
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });

        // File Input
        imageInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                handleFileSelect(e.target.files[0]);
            }
        });

        // Slider
        componentsSlider.addEventListener('input', (e) => {
            components = parseInt(e.target.value);
            componentsValue.textContent = components;
        });

        // Buttons
        compressBtn.addEventListener('click', handleCompress);
        cancelBtn.addEventListener('click', reset);
        anotherImageBtn.addEventListener('click', reset);
        downloadBtn.addEventListener('click', handleDownload);

        // Feature Card Click
        const featureCards = document.querySelectorAll('.feature-card');
        const modalOverlay = document.createElement('div');
        const modalContent = document.createElement('div');
        const modalHeader = document.createElement('div');
        const modalIcon = document.createElement('div');
        const modalTitle = document.createElement('h3');
        const modalDescription = document.createElement('p');
        const modalClose = document.createElement('button');

        modalOverlay.classList.add('modal-overlay');
        modalContent.classList.add('modal-content');
        modalHeader.classList.add('modal-header');
        modalIcon.classList.add('modal-icon');
        modalTitle.classList.add('modal-title');
        modalDescription.classList.add('modal-description');
        modalClose.classList.add('modal-close');

        modalClose.textContent = '√ó';

        modalHeader.appendChild(modalIcon);
        modalHeader.appendChild(modalTitle);
        modalContent.appendChild(modalHeader);
        modalContent.appendChild(modalDescription);
        modalContent.appendChild(modalClose);
        modalOverlay.appendChild(modalContent);

        document.body.appendChild(modalOverlay);

        featureCards.forEach(card => {
            card.addEventListener('click', () => {
                const title = card.getAttribute('data-title');
                const description = card.getAttribute('data-description');
                const icon = card.querySelector('.feature-icon').style.background;
                const iconEmoji = card.querySelector('.feature-icon').textContent;

                modalTitle.textContent = title;
                modalDescription.textContent = description;
                modalIcon.style.background = icon;
                modalIcon.textContent = iconEmoji;
                modalOverlay.classList.add('active');
            });
        });

        modalClose.addEventListener('click', () => {
            modalOverlay.classList.remove('active');
        });

        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                modalOverlay.classList.remove('active');
            }
        });

        // Functions
        function handleFileSelect(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            selectedFile = file;
            fileName.textContent = `Selected: ${file.name}`;
            
            uploadSection.classList.add('hidden');
            howItWorksSection.classList.add('hidden');
            controlsSection.classList.remove('hidden');
        }

        async function handleCompress() {
            if (!selectedFile) return;

            compressBtn.disabled = true;
            compressBtn.innerHTML = '<span class="spinner">‚è≥</span> Compressing...';

            try {
                const result = await compressImage(selectedFile, components);
                displayResults(result);
            } catch (error) {
                console.error('Compression failed:', error);
                alert('Compression failed. Please try again.');
            } finally {
                compressBtn.disabled = false;
                compressBtn.textContent = 'Compress Image';
            }
        }

        function compressImage(file, components) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Create canvas for original image
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        // Draw original image
                        ctx.drawImage(img, 0, 0);
                        const originalDataUrl = canvas.toDataURL('image/png');
                        
                        // Get image data for compression
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        
                        // Simulate PCA compression
                        const compressionFactor = components / 100;
                        
                        for (let i = 0; i < data.length; i += 4) {
                            const quantizationLevel = Math.max(1, Math.floor(32 * (1 - compressionFactor)));
                            
                            data[i] = Math.round(data[i] / quantizationLevel) * quantizationLevel;
                            data[i + 1] = Math.round(data[i + 1] / quantizationLevel) * quantizationLevel;
                            data[i + 2] = Math.round(data[i + 2] / quantizationLevel) * quantizationLevel;
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                        
                        const quality = 0.3 + (compressionFactor * 0.6);
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        // Calculate stats
                        const originalSize = file.size;
                        const compressedSize = Math.floor(compressedDataUrl.length * 0.75);
                        
                        const formatSize = (bytes) => {
                            if (bytes < 1024) return bytes + ' B';
                            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
                            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
                        };
                        
                        const ratio = (originalSize / compressedSize).toFixed(2);
                        const mse = (100 - components).toFixed(2);
                        
                        resolve({
                            originalDataUrl,
                            compressedDataUrl,
                            stats: {
                                originalSize: formatSize(originalSize),
                                compressedSize: formatSize(compressedSize),
                                compressionRatio: ratio + ':1',
                                mse: mse,
                            },
                        });
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            });
        }

        function displayResults(result) {
            compressedDataUrl = result.compressedDataUrl;

            // Display images
            document.getElementById('originalImage').src = result.originalDataUrl;
            document.getElementById('compressedImage').src = result.compressedDataUrl;

            // Display badges
            document.getElementById('originalSizeBadge').textContent = result.stats.originalSize;
            document.getElementById('compressedSizeBadge').textContent = result.stats.compressedSize;

            // Display stats
            document.getElementById('statOriginalSize').textContent = result.stats.originalSize;
            document.getElementById('statCompressedSize').textContent = result.stats.compressedSize;
            document.getElementById('statRatio').textContent = result.stats.compressionRatio;
            document.getElementById('statMSE').textContent = result.stats.mse;

            // Quality indicator
            const mse = parseFloat(result.stats.mse);
            let qualityText = '';
            
            if (mse < 30) {
                qualityText = '<strong style="color: #065f46;">Excellent quality:</strong> Minimal visual difference from original';
            } else if (mse < 60) {
                qualityText = '<strong style="color: #1e40af;">Good quality:</strong> Slight quality reduction, great compression';
            } else {
                qualityText = '<strong style="color: #c2410c;">High compression:</strong> Noticeable quality loss, maximum space savings';
            }
            
            document.getElementById('qualityText').innerHTML = qualityText;

            // Show results
            controlsSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
        }

        function handleDownload() {
            if (!compressedDataUrl) return;

            const link = document.createElement('a');
            link.href = compressedDataUrl;
            link.download = 'compressed-image.jpg';
            link.click();
        }

        function reset() {
            selectedFile = null;
            compressedDataUrl = null;
            components = 50;
            componentsSlider.value = 50;
            componentsValue.textContent = '50';
            imageInput.value = '';

            controlsSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            howItWorksSection.classList.remove('hidden');
        }
    </script>
</body>
</html>